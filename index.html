<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RMO Cosmo ‚Äî Reservoir Management Super App (v3.7)</title>
<style>
:root{
  --bg:#090e19; --panel:#0f1626; --panel-2:#111a2e; --text:#e6f0ff; --muted:#9bb0cf;
  --line:rgba(255,255,255,.08);
  --cyan:#00e5ff; --mint:#36f3c3; --violet:#8a7dff; --aqua:#39d3ff; --turq:#34c7a5;
  --danger:#ff6b6b; --ok:#39e58a; --warn:#ffbf69;
  --shadow:0 10px 30px rgba(0,229,255,.14),0 6px 20px rgba(0,0,0,.35);
  --glass:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  background:
    radial-gradient(1400px 900px at 20% -10%, rgba(0,229,255,.10), transparent),
    radial-gradient(1000px 600px at 110% 20%, rgba(54,243,195,.08), transparent),
    var(--bg);
  color:var(--text); overflow:hidden;
}
/* Fancy Scrollbars */
::-webkit-scrollbar{width:12px;height:12px}
::-webkit-scrollbar-thumb{background:linear-gradient(180deg, rgba(0,229,255,.45), rgba(54,243,195,.45));border-radius:999px;border:3px solid transparent;background-clip:padding-box;box-shadow:0 0 18px rgba(0,229,255,.25)}
::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg, rgba(0,229,255,.7), rgba(54,243,195,.7))}
*{scrollbar-color: rgba(0,229,255,.55) transparent; scrollbar-width:thin}

/* Topbar */
.topbar{height:56px; display:flex; align-items:center; gap:14px; padding:0 16px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, rgba(17,26,46,.6), rgba(17,26,46,.35)); backdrop-filter: blur(12px); position:relative; z-index:5;}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.35px}
.logo{width:26px; height:26px; border-radius:9px; background:conic-gradient(from 30deg, var(--cyan), var(--mint), #5fd6ff, var(--cyan)); box-shadow:0 0 18px rgba(0,229,255,.6); animation:spin 16s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tag{font-size:12px; color:var(--muted); border:1px solid var(--line); padding:2px 8px; border-radius:999px}
.search{flex:1; display:flex}
.search input{width:100%; background:var(--panel); border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:12px; outline:none}
.usercard{display:flex; align-items:center; gap:10px}
.avatar{width:32px; height:32px; border-radius:50%; background:#133; overflow:hidden}
.nameRole{display:flex; flex-direction:column; line-height:1.1}
.name{font-weight:700} .role{font-size:12px; color:var(--muted)}
.btn{background:transparent; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer}

/* Layout */
.wrap{display:grid; grid-template-columns: 340px 1fr; grid-template-rows: 1fr 80px; height: calc(100% - 56px);}
.sidebar{border-right:1px solid var(--line); background:linear-gradient(180deg, rgba(15,22,38,.8), rgba(15,22,38,.5)); padding:12px; overflow:auto}
.workspace{position:relative; overflow:auto; background:radial-gradient(800px 400px at 60% -10%, rgba(0,229,255,.06), transparent)}

/* Accordion groups (themes) */
.group{margin-bottom:12px; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:var(--panel)}
.g-head{display:flex; align-items:center; gap:10px; padding:10px; cursor:pointer; background:var(--glass)}
.g-title{font-weight:800}
.g-body{display:none; padding:10px; gap:8px}
.group.open .g-body{display:flex; flex-direction:column}
.ws-btn{display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer}
.ws-btn:hover{box-shadow:0 0 0 2px rgba(0,229,255,.18) inset}
.ws-name{font-weight:600}
.ws-desc{font-size:12px; color:var(--muted)}

/* Glowing icons */
.glyph{width:22px;height:22px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;position:relative}
.glyph::after{content:""; position:absolute; inset:-4px; border-radius:10px; filter:blur(6px); opacity:.6}
.t-dx{background:rgba(0,229,255,.15)} .t-dx::after{background:radial-gradient(circle, rgba(0,229,255,.6), transparent)}
.t-ms{background:rgba(57,211,255,.15)} .t-ms::after{background:radial-gradient(circle, rgba(57,211,255,.6), transparent)}
.t-wf{background:rgba(77,243,195,.15)} .t-wf::after{background:radial-gradient(circle, rgba(77,243,195,.6), transparent)}
.t-rg{background:rgba(52,199,165,.15)} .t-rg::after{background:radial-gradient(circle, rgba(52,199,165,.6), transparent)}
.t-rp{background:rgba(138,125,255,.15)} .t-rp::after{background:radial-gradient(circle, rgba(138,125,255,.6), transparent)}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.glyph{animation:pulse 2.8s ease-in-out infinite}

/* Canvas */
.canvas{padding:16px; display:flex; flex-direction:column; gap:12px}
.options{display:flex; flex-wrap:wrap; gap:8px}
.option{background:var(--panel); border:1px solid var(--line); border-radius:999px; padding:8px 12px; cursor:pointer; box-shadow:var(--shadow)}
.grid{display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap:12px}
.tile{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:var(--shadow); position:relative}
.tile h4{margin:0 0 6px 0}
.small{font-size:12px; color:var(--muted)}

/* Windows */
.window{position:absolute; background:var(--panel-2); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
.win-header{height:40px; display:flex; align-items:center; gap:8px; padding:0 10px; background:var(--glass); border-bottom:1px solid var(--line); cursor:move}
.dot{width:10px; height:10px; border-radius:999px}
.red{background:#ff5f56} .yellow{background:#ffbd2e} .green{background:#27c93f}
.win-title{flex:1; font-weight:700; font-size:14px}
.win-actions button{background:transparent; border:1px solid var(--line); color:var(--muted); padding:6px 8px; border-radius:8px; cursor:pointer}
.win-body{padding:12px; max-height:420px; overflow:auto}

/* Footer/Dock */
.dock{grid-column:1/3; border-top:1px solid var(--line); background:linear-gradient(180deg, rgba(17,26,46,.6), rgba(17,26,46,.3)); padding:10px 14px; display:flex; gap:10px; align-items:center}
.kpi-label{font-size:12px; color:var(--muted); margin-right:4px}
.kpis{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.kpi{display:flex; align-items:center; gap:8px; background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:999px; padding:6px 10px; cursor:pointer}
.delta.up{color:var(--ok)} .delta.down{color:var(--danger)}
.spark{width:60px;height:18px;opacity:.7}
.rightpad{margin-left:auto; display:flex; align-items:center; gap:10px}
.noc{height:30px; opacity:.95}

/* Cosmonaut (right rail) */
.cosmo{position:fixed; right:0; top:56px; bottom:80px; width:400px; max-width:46vw; background:var(--panel); border-left:1px solid var(--line); box-shadow:var(--shadow); display:flex; flex-direction:column; z-index:6}
.cos-head{height:44px; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:0 10px; background:var(--glass); border-bottom:1px solid var(--line)}
.cos-body{flex:1; overflow:auto; padding:10px; position:relative}
.cos-msg{margin:8px 0} .cos-me{color:var(--cyan)} .cos-ai{color:#a6e8ff}
.cos-actions{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 44px 0}
.caps{position:absolute; left:10px; right:10px; bottom:10px; display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-start}
.cap{font-size:11px; background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:999px; padding:3px 8px; cursor:pointer; white-space:nowrap}
.cos-input{display:flex; gap:8px; padding:10px; border-top:1px solid var(--line)}
.cos-input input{flex:1; background:transparent; border:1px solid var(--line); border-radius:10px; padding:8px 10px; color:var(--text); outline:none}
.min{width:40px; text-align:center}
.hidden{display:none} .minimized{width:56px} .minimized .cos-body, .minimized .cos-input{display:none}

@media (max-width: 1200px){
  .wrap{grid-template-columns: 300px 1fr}
  .grid{grid-template-columns: repeat(2, minmax(220px,1fr))}
  .cosmo{width:340px}
}
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>RMO <b>Cosmo</b> <span class="tag">Reservoir Management Super App</span></div>
    </div>
    <div class="search"><input id="globalSearch" placeholder="Search wells, modules, workstreams (‚åòK)"></div>
    <button id="toggleCosmo" class="btn">Cosmonaut</button>
    <div class="usercard">
      <img class="avatar" src="{avatar_data_uri}" alt="Aldhyt Sukapradja photo"/>
      <div class="nameRole">
        <span class="name">Aldhyt SUKAPRADJA</span>
        <span class="role">Senior Geologist</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <aside class="sidebar" id="sidebar"></aside>

    <section class="workspace" id="workspace">
      <div class="canvas">
        <div class="small">Select a workstream to see canvas options and tiles. Charts appear inside opened windows.</div>
        <div id="canvasOptions" class="options"></div>
        <div id="canvasGrid" class="grid"></div>
      </div>
    </section>

    <footer class="dock">
      <span class="kpi-label">Key KPIs:</span>
      <div class="kpis" id="kpiRow"></div>
      <div class="rightpad">
        <img class="noc" src="data:image/png;base64,{logo_b64}" alt="North Oil Company"/>
      </div>
    </footer>
  </main>

  <!-- Cosmonaut Right Rail -->
  <aside id="cosmo" class="cosmo">
    <div class="cos-head"><b>üßë‚ÄçüöÄ Cosmonaut</b>
      <div>
        <button id="minCosmo" class="btn min">‚ñæ</button>
        <button id="closeCosmo" class="btn min">‚úï</button>
      </div>
    </div>
    <div class="cos-body" id="cosBody">
      <div class="small"><b>Context:</b> <span id="ctx">Well ‚Äî ‚Äî | Theme ‚Äî ‚Äî</span></div>
      <div class="cos-actions">
        <button class="btn" id="actGuard">Open Guard Pack</button>
        <button class="btn" id="actSeismic">Open Seismic Map</button>
        <button class="btn" id="actReport">Create Report</button>
      </div>
      <div id="chat">
        <div class="cos-msg cos-ai">üåå Online ‚Äî ready for your mission, Commander Aldhyt.</div>
      </div>
      <div class="caps" id="caps"></div>
    </div>
    <div class="cos-input">
      <input id="cosInput" placeholder="Ask Cosmonaut (‚åò/Ctrl+J)‚Ä¶ e.g., show 30-day production trend" />
      <button id="cosSend" class="btn">Send</button>
    </div>
  </aside>

<script>
/************** Themes & Workstreams with updated icons (emoji fallback) **************/
const themes = [
  {id:'dx', name:'Diagnostic & Health', color:'var(--cyan)', icon:'üí†'},
  {id:'ms', name:'Reservoir Monitoring & Surveillance', color:'var(--aqua)', icon:'üì°'},
  {id:'wf', name:'Waterflood Optimization', color:'var(--mint)', icon:'üåä'},
  {id:'rg', name:'Rigbased/less Opportunities', color:'var(--turq)', icon:'üß∞'},
  {id:'rp', name:'Knowledge Base & Reporting', color:'var(--violet)', icon:'üìñ'},
];

const ws = [
  // Diagnostic & Health
  {id:'kpi', name:'KPI Monitoring', theme:'dx', tags:['kpi'], icon:'üìä', desc:'Automated KPI snapshots for leadership.'},
  {id:'health', name:'Health Check Dashboard', theme:'dx', tags:['kpi'], icon:'üíì', desc:'Reservoir health overview.'},
  {id:'decline', name:'Decline Curve', theme:'dx', tags:['production'], icon:'üìâ', desc:'Decline trends and forecasts.'},
  {id:'sypher', name:'Sypher', theme:'dx', tags:['production'], icon:'üî¨', desc:'PI/II analytics and correlation.'},

  // Monitoring & Surveillance
  {id:'rsp', name:'RSP/RESM Gain', theme:'ms', tags:['production'], icon:'üìà', desc:'Surveillance plan and realized gains.'},
  {id:'daily', name:'Daily Reservoir Performance Report', theme:'ms', tags:['production'], icon:'üìÖ', desc:'Daily production deviations vs plan.'},
  {id:'wellwatch', name:'Wellwatch', theme:'ms', tags:['production'], icon:'üö®', desc:'Agentic alarms + recommendations.'},
  {id:'aura', name:'Aura', theme:'ms', tags:['seismic'], icon:'üåÄ', desc:'Seismic inversion insights.'},
  {id:'geaguard', name:'GeaGuard', theme:'ms', tags:['seismic','guard'], icon:'üåê', desc:'Geomech surveillance (seismic-based).'},
  {id:'terra', name:'TerraGuard', theme:'ms', tags:['seismic','guard'], icon:'üß≠', desc:'Seismic & fracture orientation.'},

  // Waterflood Optimization
  {id:'aquaman', name:'AquaMan', theme:'wf', tags:['production'], icon:'üíß', desc:'Water injection optimization.'},
  {id:'flowguard', name:'FlowGuard', theme:'wf', tags:['production','guard'], icon:'üîÑ', desc:'Benchmark & flow analytics.'},
  {id:'pattern', name:'Pattern Flood Management', theme:'wf', tags:['production'], icon:'üó∫Ô∏è', desc:'VRR & pattern efficiency.'},
  {id:'voidage', name:'VoidageGuard', theme:'wf', tags:['production','guard'], icon:'‚öôÔ∏è', desc:'VRR balance & diagnostics.'},
  {id:'sweep', name:'SweepGuard', theme:'wf', tags:['production','guard'], icon:'‚ôªÔ∏è', desc:'Sweep alignment & FAST score.'},
  {id:'wellguard', name:'WellGuard', theme:'wf', tags:['kpi','guard'], icon:'üõ°Ô∏è', desc:'Non-conformance & risk flags.'},
  {id:'fracguard', name:'FracGuard', theme:'wf', tags:['kpi','guard'], icon:'üí•', desc:'Frac risk & event detection.'},

  // Rigbased & Reporting link
  {id:'stim', name:'StimAtlas', theme:'rg', tags:['kpi','production'], icon:'üî•', desc:'Stimulation candidates & strategy.'},
  {id:'wellnova', name:'Wellnova', theme:'rg', tags:['kpi'], icon:'üìò', desc:'Post-drill post-mortem reporting.'},

  // Reporting
  {id:'rmo360', name:'RMO360', theme:'rp', tags:['kpi'], icon:'üåê', desc:'Unified hub & ops reporting.'},
  {id:'prodcast', name:'Prodcast', theme:'rp', tags:['production'], icon:'üìâ', desc:'Decline curve analysis & forecast.'},
  {id:'shr', name:'Shareholders RESM', theme:'rp', tags:['kpi'], icon:'üíº', desc:'Stakeholder KPI pack.'},
];

const aliases = [
  {id:'wellnova', alsoIn:['rp']},
  {id:'terra', alsoIn:['wf']},
  {id:'geaguard', alsoIn:['wf']}
];

const combos = {
  kpi:['RMO Dashboard Factory','Prodcast'],
  health:['FlowGuard','VoidageGuard'],
  decline:['WellWatch Live','ProdMax'],
  sypher:['PI/II Analyzer'],
  rsp:['Reservoir Map','VoidageGuard'],
  daily:['FlowGuard','HeatMap BI'],
  wellwatch:['WellWatch Live','RMO Chronos'],
  aura:['SeisTrack','4D Insight'],
  geaguard:['Vector Map','GeaGuard','TerraGuard'],
  terra:['Vector Map','TerraGuard','GeaGuard'],

  aquaman:['SweepGuard','VoidageGuard'],
  flowguard:['FlowGuard','HeatMap BI'],
  pattern:['FAST Optimizer','SweepGuard'],
  voidage:['VoidageGuard','Reservoir Map'],
  sweep:['SweepGuard','Reservoir Map'],
  wellguard:['Agent Studio','Knowledge Hub'],
  fracguard:['FracGuard','FracScope'],

  stim:['Reservoir Map','WellWatch Live','StimAtlas'],
  wellnova:['PostDrill AutoReport','Health Index'],

  rmo360:['RMO Cosmo'],
  prodcast:['Prodcast','Dashboard Factory'],
  shr:['Dashboard Factory']
};

const presets = {
  'Reservoir Map': {x:24,  y:120, w:600, h:320},
  'Vector Map':    {x:24,  y:120, w:620, h:360},
  'WellWatch Live':{x:660, y:120, w:520, h:220},
  'VoidageGuard':  {x:660, y:348, w:520, h:164},
  'SweepGuard':    {x:660, y:520, w:520, h:164},
  'StimAtlas':     {x:24,  y:492, w:520, h:220},
  'RMO Chronos':   {x:552, y:492, w:608, h:220},
  'PostDrill AutoReport': {x:24, y:460, w:640, h:320},
  'Health Index': {x:680, y:460, w:480, h:320},
  'Wellnova Report (Mock)': {x:120, y:100, w:840, h:540}
};

const wells = ['ASH-P-270','ASH-P-118','ASH-I-045','ASH-I-122','ASH-WD-010'];
const context = { selectedWell:null, theme:null, mission:null };

/************** Sidebar **************/
const sidebar = document.getElementById('sidebar');
function buildSidebar(){
  themes.forEach(th=>{
    const g = document.createElement('div'); g.className='group';
    const head = document.createElement('div'); head.className='g-head';
    const icon = document.createElement('div'); icon.className='glyph t-'+th.id; icon.textContent = th.icon;
    const title = document.createElement('div'); title.className='g-title'; title.textContent = th.name;
    head.append(icon,title);
    head.onclick=()=>{ g.classList.toggle('open'); context.theme = th.name; renderContext(); };
    const body = document.createElement('div'); body.className='g-body';
    ws.filter(x=> x.theme===th.id || (aliases.find(a=>a.id===x.id && a.alsoIn?.includes(th.id)))).forEach(item=>{
      const b = document.createElement('div'); b.className='ws-btn';
      const gy = document.createElement('div'); gy.className='glyph t-'+th.id; gy.textContent=item.icon;
      const nm = document.createElement('div'); nm.className='ws-name'; nm.textContent=item.name;
      const ds = document.createElement('div'); ds.className='ws-desc'; ds.textContent=item.desc;
      b.append(gy,nm); b.appendChild(ds);
      b.onclick=()=> selectWS(item);
      body.appendChild(b);
    });
    g.append(head,body);
    sidebar.appendChild(g);
  });
  const first = sidebar.querySelector('.group'); if(first) first.classList.add('open');
}

const canvasOptions = document.getElementById('canvasOptions');
const canvasGrid = document.getElementById('canvasGrid');
function selectWS(item){
  canvasOptions.innerHTML=''; canvasGrid.innerHTML='';
  context.theme = themes.find(t=> t.id===item.theme)?.name || context.theme;
  const cx = combos[item.id]||[];
  if(cx.length){
    const opt = document.createElement('div'); opt.className='option';
    opt.textContent = 'Open combo: '+cx.join(' + ');
    opt.onclick = ()=> openCombo(cx);
    canvasOptions.appendChild(opt);
  }
  (cx.length?cx:['Open Module']).forEach(name=>{
    const el = document.createElement('div'); el.className='tile';
    el.innerHTML = `<h4>${name}</h4><div class="small">${item.desc}</div><div class="small">Tags: ${item.tags.join(', ')}</div>`;
    el.onclick = ()=> openModule(name, item.tags);
    canvasGrid.appendChild(el);
  });
  if(['flowguard','voidage','sweep','aquaman','pattern'].includes(item.id)){
    const pack = document.createElement('div'); pack.className='option'; pack.textContent='Open Guard Pack (Voidage+Sweep+FlowGuard+Reservoir Map)';
    pack.onclick=()=> openCombo(['VoidageGuard','SweepGuard','FlowGuard','Reservoir Map']);
    canvasOptions.appendChild(pack);
  }
  renderContext(); pushCaps(item);
}

/************** Windows / Modules **************/
const workspace = document.getElementById('workspace');
const openWindows = new Map();
function openCombo(list){
  list.forEach(name=>{
    openModule(name, inferTagsFromName(name));
    const w = openWindows.get(name); if(w) snapToPreset(name, w);
  });
}
function openModule(name, tags=[]){
  if(openWindows.has(name)){ focusWindow(openWindows.get(name)); return; }
  const win = document.createElement('div');
  win.className='window';
  win.style.left = (Math.random()*180 + 24) + 'px';
  win.style.top  = (Math.random()*140 + 120) + 'px';
  win.style.width= '560px'; win.style.height='260px';
  win.innerHTML = `
    <div class="win-header">
      <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
      <div class="win-title">${name}</div>
      <div class="win-actions">
        <button data-act="snap">Snap</button>
        <button data-act="pin">Pin</button>
        <button data-act="close">Close</button>
      </div>
    </div>
    <div class="win-body" data-body></div>`;
  attachWin(win,name);
  workspace.appendChild(win);
  openWindows.set(name, win);
  renderModule(win,name,tags);
  focusWindow(win);
}
function focusWindow(win){
  const maxZ = Math.max(5, ...[...workspace.children].map(el=>+getComputedStyle(el).zIndex||5));
  win.style.zIndex = maxZ + 1;
}
function attachWin(win,name){
  const header = win.querySelector('.win-header');
  let drag=false, dx=0, dy=0;
  header.addEventListener('mousedown', (e)=>{
    if(e.target.closest('.win-actions')) return;
    drag=true; dx=e.clientX - win.offsetLeft; dy=e.clientY - win.offsetTop;
  });
  document.addEventListener('mousemove', (e)=>{ if(!drag) return; win.style.left=(e.clientX-dx)+'px'; win.style.top=(e.clientY-dy)+'px'; });
  document.addEventListener('mouseup', ()=> drag=false);
  header.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const act = btn.dataset.act;
      if(act==='close'){ workspace.removeChild(win); openWindows.delete(name); }
      if(act==='snap'){ snapToPreset(name,win); }
      if(act==='pin'){ win.style.boxShadow = '0 0 0 2px rgba(0,229,255,.5), '+getComputedStyle(win).boxShadow; }
    });
  });
}
function snapToPreset(name,win){
  if(presets[name]){
    const p = presets[name];
    win.style.left=p.x+'px'; win.style.top=p.y+'px'; win.style.width=p.w+'px'; win.style.height=p.h+'px';
  }
}

/************** Module Rendering (charts/maps/report) **************/
function renderModule(win,name,tags){
  const body = win.querySelector('[data-body]');
  const well = context.selectedWell || '‚Äî';
  if(name==='Vector Map'){ body.innerHTML = vectorMapSVG(); return; }
  if(name==='Wellnova Report (Mock)'){ body.innerHTML = wellnovaReportHTML(well); return; }
  const needLine = tags.includes('production');
  const needKPI  = tags.includes('kpi');
  let inner = `<div class="small">Context Well: <b>${well}</b></div>`;
  if(needLine) inner += lineChartSVG(460,150,true);
  if(needKPI)  inner += `<div style="display:flex; gap:8px; align-items:flex-start">${barChartSVG(280,150,true)}${pieChartSVG(150,true)}</div>`;
  if(name==='WellWatch Live') inner += `<div class='small'>Agentic alarms & recommendations (mock)</div>`;
  if(name==='StimAtlas') inner += stimAtlasPane();
  if(name==='Prodcast') inner += declinePane();
  body.innerHTML = inner;
}

/************** Chart placeholders (SVG with axes) **************/
function rand(a,b){ return a + Math.random()*(b-a); }
function lineChartSVG(W=460,H=150,axes=false){
  const n=36, pad=28;
  let pts=[]; let y=rand(40,80);
  for(let i=0;i<n;i++){ y += rand(-8,8); y=Math.max(10,110,y); pts.push([pad+i*((W-2*pad)/(n-1)), H - (y) + 10]); }
  const path = pts.map((p,i)=> (i? 'L':'M') + p[0].toFixed(1)+','+p[1].toFixed(1)).join(' ');
  let axesSVG=''; if(axes) axesSVG = `<g stroke="white" stroke-opacity=".15"><line x1="${pad}" y1="${H-8}" x2="${W-6}" y2="${H-8}"/><line x1="${pad}" y1="12" x2="${pad}" y2="${H-8}"/></g>`;
  return `<svg class="spark" viewBox="0 0 ${W} ${H}" style="width:${W}px;height:${H}px;background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:10px">
    ${axesSVG}
    <path d="${path}" fill="none" stroke="url(#lg)" stroke-width="2"/>
    <defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="var(--cyan)"/><stop offset="100%" stop-color="var(--mint)"/></linearGradient></defs>
  </svg>`;
}
function barChartSVG(W=280,H=150,axes=false){
  const bars=7, pad=28, bw=(W-2*pad)/bars*.7, gap=(W-2*pad)/bars*.3;
  let rects=''; for(let i=0;i<bars;i++){ const h=rand(22,H-36); const x=pad+i*(bw+gap); const y=H-h-10; rects += `<rect x="${x}" y="${y}" width="${bw}" height="${h}" rx="4" ry="4" fill="url(#bg)"/>`; }
  let axesSVG=''; if(axes) axesSVG = `<g stroke="white" stroke-opacity=".15"><line x1="${pad}" y1="${H-8}" x2="${W-6}" y2="${H-8}"/><line x1="${pad}" y1="12" x2="${pad}" y2="${H-8}"/></g>`;
  return `<svg viewBox="0 0 ${W} ${H}" style="width:${W}px;height:${H}px;background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:10px">
    ${axesSVG}
    <defs><linearGradient id="bg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--cyan)"/><stop offset="100%" stop-color="var(--mint)"/></linearGradient></defs>
    ${rects}
  </svg>`;
}
function pieChartSVG(S=150){
  const cx=S/2, cy=S/2, r=S/2-10;
  const vals=[rand(10,40),rand(10,40),rand(10,40)]; const total=vals.reduce((a,b)=>a+b,0);
  let a0=-Math.PI/2, segs='';
  const colors=['var(--mint)','var(--cyan)','var(--violet)'];
  vals.forEach((v,i)=>{ const a1=a0+2*Math.PI*(v/total); const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0); const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1); const large=(a1-a0)>Math.PI?1:0; segs += `<path d="M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z" fill="${colors[i%colors.length]}"/>`; a0=a1; });
  return `<svg viewBox="0 0 ${S} ${S}" style="width:${S}px;height:${S}px;background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:10px">${segs}</svg>`;
}

/************** Seismic Vector Map **************/
function vectorMapSVG(W=620,H=360){
  let wellsSVG = ['ASH-P-270','ASH-P-118','ASH-I-045','ASH-I-122','ASH-WD-010'].map((w,i)=>{
    const x=80 + i*100, y=120 + (i%2)*70;
    return `<circle cx="${x}" cy="${y}" r="6" fill="var(--mint)" stroke="white" stroke-width="1"><title>${w}</title></circle>`;
  }).join('');
  let arrows=''; for(let i=0;i<8;i++){ const x=60+i*70, y=60+(i%3)*90, dx=24+(i%2)*14, dy=10-(i%2)*8;
    arrows += `<line x1="${x}" y1="${y}" x2="${x+dx}" y2="${y+dy}" stroke="var(--cyan)" stroke-width="2" marker-end="url(#arr)"/>`; }
  return `<svg width="${W}" height="${H}" style="background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:10px">
    <defs><marker id="arr" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="var(--cyan)"/></marker></defs>
    <g opacity=".22">${gridSVG(W,H,40)}</g>
    <polyline points="10,300 80,260 160,280 240,240 320,260 380,220 460,240 560,200" fill="none" stroke="white" stroke-opacity=".25"/>
    ${wellsSVG}
    ${arrows}
  </svg>`;
}
function gridSVG(W,H,step){
  let g=''; for(let x=0;x<W;x+=step) g+=`<line x1="${x}" y1="0" x2="${x}" y2="${H}" stroke="white" stroke-opacity=".08"/>`;
  for(let y=0;y<H;y+=step) g+=`<line x1="0" y1="${y}" x2="${W}" y2="${y}" stroke="white" stroke-opacity=".08"/>`;
  return g;
}

/************** Wellnova Report Mock **************/
function wellnovaReportHTML(well){
  const today = new Date().toISOString().slice(0,10);
  return `
  <div style="font-family: ui-sans-serif">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding-bottom:6px;margin-bottom:10px">
      <div><b>RMO Cosmo | Wellnova</b></div>
      <div class="small">${today}</div>
    </div>
    <h2 style="margin:.2rem 0">Post-Drill Analysis ‚Äî ${well}</h2>
    <p class="small">Author: Aldhyt ¬∑ Generated by Cosmonaut</p>
    <h3>Key KPIs</h3>
    <div style="display:flex; gap:8px; align-items:flex-start">${barChartSVG(320,160,true)}${pieChartSVG(160)}</div>
    <h3>Production Trend</h3>
    ${lineChartSVG(720,180,true)}
    <h3>Treatments / Events</h3>
    <table style="width:100%;border-collapse:collapse" class="small">
      <tr><td style="border-bottom:1px solid var(--line)">Date</td><td style="border-bottom:1px solid var(--line)">Event</td><td style="border-bottom:1px solid var(--line)">Notes</td></tr>
      <tr><td>‚Äî</td><td>‚Äî</td><td>Mock placeholders</td></tr>
    </table>
    <h3>Findings & Recommendations</h3>
    <ul class="small"><li>Finding 1 (placeholder)</li><li>Finding 2 (placeholder)</li><li>Recommendation 1 (placeholder)</li></ul>
    <div style="margin-top:10px; display:flex; gap:8px">
      <button class="btn" onclick="print()">Print</button>
      <button class="btn" onclick="downloadHTML()">Export HTML</button>
    </div>
  </div>`;
}
function downloadHTML(){
  const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='rmo_cosmo_superapp_v3_7.html'; a.click();
  URL.revokeObjectURL(url);
}

/************** Global search **************/
const gs = document.getElementById('globalSearch');
document.addEventListener('keydown', e=>{
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ gs.focus(); e.preventDefault(); }
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='j'){ document.getElementById('cosInput').focus(); e.preventDefault(); }
});

/************** Cosmonaut **************/
const cosmo = document.getElementById('cosmo');
document.getElementById('toggleCosmo').onclick = ()=>{ cosmo.classList.remove('hidden'); cosmo.classList.remove('minimized'); };
document.getElementById('minCosmo').onclick = ()=>{ cosmo.classList.toggle('minimized'); };
document.getElementById('closeCosmo').onclick = ()=>{ cosmo.classList.add('hidden'); };

const cosBody = document.getElementById('chat');
const cosInput = document.getElementById('cosInput');
document.getElementById('cosSend').onclick = submitCos;
cosInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitCos(); });

function submitCos(){
  const v = cosInput.value.trim(); if(!v) return;
  pushChat('me', v);
  routeCos(v);
  cosInput.value='';
}
function pushChat(role,text){
  const div = document.createElement('div');
  div.className = 'cos-msg '+(role==='me'?'cos-me':'cos-ai');
  div.textContent = (role==='me'?'You: ':'Cosmonaut: ')+text;
  cosBody.appendChild(div); cosBody.scrollTop = cosBody.scrollHeight;
}
function renderContext(){
  const t = context.theme || '‚Äî ‚Äî';
  const w = context.selectedWell || '‚Äî ‚Äî';
  document.getElementById('ctx').textContent = `Well ${w} | Theme ${t}`;
}
function pushCaps(item){
  const caps = document.getElementById('caps'); caps.innerHTML='';
  const list = [];
  if(item.tags.includes('production')) list.push('üìà 30d trend','üßÆ Decline fit P50');
  if(item.tags.includes('kpi')) list.push('üìä KPI snapshot','üß© KPI composition');
  if(item.tags.includes('seismic')) list.push('üß≠ Fracture vectors','üéØ Recenter on well');
  if(['voidage','sweep','flowguard'].includes(item.id)) list.push('‚ôªÔ∏è Guard Pack','üõ∞Ô∏è VRR map');
  ['üó∫Ô∏è Seismic Map','üìò Create Report'].forEach(s=>list.push(s));
  list.forEach(s=>{ const c = document.createElement('div'); c.className='cap'; c.textContent=s; c.onclick=()=>{ cosInput.value=s.replace(/^[^ ]+ /,''); submitCos(); }; caps.appendChild(c); });
}
function routeCos(q){
  const up = q.toUpperCase();
  if(/REPORT|POST-DRILL|WELLNOVA/.test(up)){ openModule('Wellnova Report (Mock)', ['kpi']); pushChat('ai','Created Wellnova mock report.'); return; }
  if(/SEISMIC|AZIMUTH|VECTOR|GEA|TERRA|MAP/.test(up)){ openCombo(['Vector Map','GeaGuard','TerraGuard']); pushChat('ai','Seismic vector map opened.'); return; }
  if(/GUARD PACK|VRR|VOIDAGE|SWEEP/.test(up)){ openCombo(['VoidageGuard','SweepGuard','FlowGuard','Reservoir Map']); pushChat('ai','Guard Pack opened.'); return; }
  if(/KPI|RESM|DASH|INDEX|HEALTH/.test(up)){ openModule('Dashboard Factory', ['kpi']); pushChat('ai','KPI views opened.'); return; }
  if(/PROD|RATE|WC|PI|II|DECLINE|FORECAST/.test(up)){ openModule('WellWatch Live', ['production']); pushChat('ai','Production trend opened.'); return; }
  pushChat('ai','Opening FlowGuard.'); openModule('FlowGuard',['production','kpi']);
}

/************** KPI Dock (left) **************/
const kpiRow = document.getElementById('kpiRow');
const kpiState = {
  oil:{label:'Oil Production', val:300000, unit:'BOPD', series:randSeries(30,280000,305000)},
  winj:{label:'WInj', val:1100, unit:'kBWIPD', series:randSeries(30,980,1120)},
  wdisp:{label:'Water Disposal', val:800, unit:'kBWIPD', series:randSeries(30,740,820)},
  vrr:{label:'VRR', val:98, unit:'%', series:randSeries(30,95,102)}
};
function randSeries(n,a,b){ return Array.from({length:n},()=> (Math.random()*(b-a)+a)); }
function deltaPct(curr, series){
  const avg = series.slice(-7).reduce((s,v)=>s+v,0)/Math.min(series.length,7);
  return ((curr/avg)-1)*100;
}
function sparkSVG(series){
  const W=60,H=18,pad=2; const min=Math.min(...series), max=Math.max(...series);
  const pts = series.map((v,i)=>{
    const x = pad + i*((W-2*pad)/(series.length-1));
    const y = H - pad - ((v-min)/(max-min+1e-6))*(H-2*pad);
    return (i?'L':'M')+x.toFixed(1)+','+y.toFixed(1);
  }).join(' ');
  return `<svg class="spark" viewBox="0 0 ${W} ${H}"><path d="${pts}" fill="none" stroke="url(#lg)" stroke-width="1.6"/><defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="var(--cyan)"/><stop offset="100%" stop-color="var(--mint)"/></linearGradient></defs></svg>`;
}
function buildKPI(){
  kpiRow.innerHTML='';
  const specs=[
    {id:'oil', open:()=> openCombo(['WellWatch Live','Prodcast'])},
    {id:'winj', open:()=> openCombo(['VoidageGuard','AquaMan'])},
    {id:'wdisp', open:()=> openCombo(['Pattern Flood Management','WellGuard'])},
    {id:'vrr', open:()=> openCombo(['VoidageGuard','SweepGuard','Reservoir Map'])},
  ];
  specs.forEach(s=>{
    const d = kpiState[s.id];
    const dlt = deltaPct(d.val, d.series);
    const arrow = dlt>0.1?'‚ñ≤':(dlt<-0.1?'‚ñº':'‚ñ¨');
    const cls = dlt>0.1?'up':(dlt<-0.1?'down':'');
    const cap = document.createElement('div'); cap.className='kpi'; cap.title=d.label;
    cap.innerHTML = `${sparkSVG(d.series)} <div><div><b>${formatVal(d.val)} ${d.unit}</b></div><div class="small">${d.label} <span class="delta ${cls}">${arrow} ${dlt.toFixed(1)}%</span></div></div>`;
    cap.onclick = s.open;
    kpiRow.appendChild(cap);
  });
}
function formatVal(v){ return v.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','); }

/************** Helpers **************/
function inferTagsFromName(name){
  const low=name.toLowerCase();
  if(/map|vector/.test(low)) return ['seismic'];
  if(/guard|flow|void|sweep|prod|wellwatch|chronos|optimizer|aqua|pattern/.test(low)) return ['production'];
  if(/dash|index|health|report|factory|auto|post|knowledge|studio|cosmo|kpi|share/.test(low)) return ['kpi'];
  return [];
}

// Build UI
buildSidebar(); renderContext(); buildKPI();
const firstWS = ws.find(x=> x.theme==='dx'); if(firstWS) selectWS(firstWS);

// Actions
document.getElementById('actGuard').onclick = ()=> openCombo(['VoidageGuard','SweepGuard','FlowGuard','Reservoir Map']);
document.getElementById('actSeismic').onclick = ()=> openCombo(['Vector Map','GeaGuard','TerraGuard']);
document.getElementById('actReport').onclick = ()=> openModule('Wellnova Report (Mock)', ['kpi']);

// Keyboard
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !cosmo.classList.contains('hidden')) cosmo.classList.add('minimized'); });
</script>
</body>
</html>
